function rV(){mN=0}function BufferLoader(e,t,o){this.context=e,this.urlList=t,this.onload=o,this.bufferList=new Array,this.loadCount=0}function init(){window.AudioContext=window.AudioContext||window.webkitAudioContext,context=new AudioContext,gainNode=context.createGain(),(bufferLoader=new BufferLoader(context,["https://nichodon.github.io/programs/0003/sounds/click1.wav","https://nichodon.github.io/programs/0003/sounds/click2.wav","https://nichodon.github.io/programs/0003/sounds/click3.wav","https://nichodon.github.io/programs/0003/sounds/accent1.wav"],fL)).load()}function fL(e){click1=context.createBufferSource(),click2=context.createBufferSource(),click3=context.createBufferSource(),accent1=context.createBufferSource(),click1.buffer=e[0],click2.buffer=e[1],click3.buffer=e[2],accent1.buffer=e[3],click1.connect(context.destination),click2.connect(context.destination),click3.connect(context.destination),accent1.connect(context.destination),buffers=e}function playSound(e,t){if(play){var o=context.createBufferSource();o.buffer=buffers[e],o.connect(context.destination),o.start(t),audios.push(o)}}function playSoundAsync(e){var t=1e3*context.currentTime;console.log(t-prevBeatTime),prevBeatTime=t;var o=new Audio(e);o.volume=volume,o.play()}function togglePlayback(){var e=document.getElementById("togglePlayback");sSC+=1,(play=!play)?(e.innerHTML="Stop",z(-1,sSC)):(e.innerHTML="Play",stopAll(),rV())}function isNormalInteger(e){var t=Math.floor(Number(e));return String(t)===e&&t>=0}function updateSignature(){var e=document.getElementById("N").value,t=document.getElementById("D").value,o=e.replace(" ","").Tm("+").split("+");if(0!==o.length){var n=0,r=0,a=!0;for(i=0;i<o.length;i++){accents[n]=!0;var c=n,u=o[i];for(isNormalInteger(u)?(n+=parseInt(u),r+=parseInt(u)):a=!1,j=c+1;j<n;j++)accents[j]=!1}a?(document.getElementById("N").style.backgroundColor="white",N=r):(document.getElementById("N").style.backgroundColor="#FF9184",N=4),1<=t&&t<=64&&Math.log2(t)%1==0?(D=t,document.getElementById("D").style.backgroundColor="white"):document.getElementById("D").style.backgroundColor="#FF9184",play&&togglePlayback()}}function updateVolume(){volume=document.getElementById("volume").value/100,gainNode.gain.value=volume}function updateBPM(){var e=document.getElementById("bpm").value;5<=e&&e<=800&&(bpm=e),mpb=1/bpm,spb=1/(bps=bpm/60),mspb=1/(bpms=bps/1e3),play&&togglePlayback()}function x(e,t){play&&(t<tR?setTimeout(e(),0):w(e,1e3*context.currentTime+t))}function w(e,t){if(play){var o=1e3*context.currentTime;t-o<tR?play&&setTimeout(e(),0):setTimeout(function(){w(e,t)},Math.max((t-o)/2,0))}}function stopAll(){for(i=0;i<audios.length;i++)audios[i].stop()}function z(e=-1,t){if(t==sSC&&play){for(-1===e&&(e=1e3*context.currentTime),audios=[],flyLine(),i=0;i<N;i++)accents[i]?playSound(3,e/1e3+i*spb):playSound(0,e/1e3+i*spb);var o=1e3*context.currentTime,n=sSC;x(function(){z(e+mspb*N,n)},mspb*N+e-o-20),mN+=1}}function flyLine(e=-1,t=0){if(clearCanvas(),play){var o=100+1300*t/(60*spb*N);if(drawBeats(o),!(o>=1400)){ctx.beginPath(),ctx.moveTo(o,0),ctx.lineTo(o,200),ctx.stroke(),-1===e&&(e=1e3*context.currentTime);var n=1e3*context.currentTime;x(function(){flyLine(e+1e3/60,t+1)},e-n+1e3/60)}}else drawBeats()}function bT(e){return[100+1300*e/N,100]}function drawCircle(e,t){ctx.beginPath(),ctx.arc(e[0],e[1],t,0,2*Math.PI),ctx.stroke()}function drawFilledCircle(e,t){ctx.beginPath(),ctx.arc(e[0],e[1],t,0,2*Math.PI),ctx.fillStyle="red",ctx.fill(),ctx.stroke()}function clearCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height)}function drawBeats(e){for(i=0;i<=N;i++){var t=bT(i);i!=N&&Math.abs(t[0]-e+5)<20?accents[i%N]?drawFilledCircle(bT(i),accentCircleRadius):drawFilledCircle(bT(i),normalCircleRadius):accents[i%N]?drawCircle(bT(i),accentCircleRadius):drawCircle(bT(i),normalCircleRadius)}}function getCursorPosition(e,t){var o=e.getBoundingClientRect(),n=t.clientX-o.left,r=t.clientY-o.top;console.log("x: "+n+" y: "+r)}var N=4,D=4,bpm=120,bps=bpm/60,bpms=bps/1e3,mpb=1/bpm,spb=1/bps,mspb=1/bpms,tR=30,accent1="sounds/accent1.wav",click1="sounds/click1.wav",click2="sounds/click2.wav",click3="sounds/click3.wav",mN=0,accents=[!0,!1,!1,!1],volume=.8,play=!1,canvas=document.getElementById("beater"),ctx=canvas.getContext("2d"),accentCircleRadius=20,normalCircleRadius=10,flylineNumber=0,audios=[],sSC=0;window.onload=init;var context,bufferLoader,gainNode;BufferLoader.prototype.loadBuffer=function(e,t){var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="arraybuffer";var n=this;o.onload=function(){n.context.decodeAudioData(o.response,function(o){o?(n.bufferList[t]=o,++n.loadCount==n.urlList.length&&n.onload(n.bufferList)):alert("error decoding file data: "+e)},function(e){console.error("decodeAudioData error",e)})},o.onerror=function(){alert("BufferLoader: XHR error")},o.send()},BufferLoader.prototype.load=function(){for(var e=0;e<this.urlList.length;++e)this.loadBuffer(this.urlList[e],e)};var click1=null,click2=null,click3=null,accent1=null,buffers=null,start=null;String.prototype.Tl=function(e){return void 0===e&&(e="s"),this.replace(new RegExp("^["+e+"]+"),"")},String.prototype.Tr=function(e){return void 0===e&&(e="s"),this.replace(new RegExp("["+e+"]+$"),"")},String.prototype.Tm=function(e){return this.Tl(e).Tr(e)},drawBeats();
