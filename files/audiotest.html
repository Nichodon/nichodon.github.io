<!doctype html>
<html>
	<head>
		<title>Awesomesauces</title>
	</head>
	<body>
		<script>
			var mode = 0;
			
			const audio = new Audio();
			audio.src = 'https://moomath.com/files/proj12.mp3';
			audio.crossOrigin = "anonymous";
			audio.autoplay = true;
			audio.preload = 'auto';

			const context = new AudioContext();
			const analyser = context.createAnalyser();
			analyser.smoothingTimeConstant = 0.9;
			analyser.connect(context.destination);
			
			const source = context.createMediaElementSource(audio);
			source.connect(analyser);

			const count = analyser.frequencyBinCount;
			const dataArray = new Float32Array(count);

			const canvas = document.createElement('canvas');
			canvas.style.position = 'absolute';
			canvas.style.top = 0;
			canvas.style.left = 0;
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			document.body.appendChild(canvas);
			const two = canvas.getContext('2d');
			two.clearRect(0, 0, canvas.width, canvas.height);
			
			canvas.onclick = function() {
				mode = mode === 2 ? 0 : mode + 1;
			};


			function draw() {
				requestAnimationFrame(draw);

				analyser.getFloatFrequencyData(dataArray);

				two.fillStyle = 'white';
				two.fillRect(0, 0, canvas.width, canvas.height);

				const barWidth = (canvas.width / count) * 2.5;
				let posX = 0;
				for (let i = 0; i < count; i++) {
					const barHeight = (dataArray[i] + 150) * 2;
					if (mode === 0) {
						two.fillStyle = 'rgb(0, ' + Math.floor(barHeight + 50) + ', 255)';
						two.fillRect(posX, canvas.height - barHeight * 2 + 200, barWidth, barHeight * 2);
					} else if (mode === 1) {
						two.strokeStyle = 'red';
						two.beginPath();
						two.moveTo(posX, canvas.height - barHeight * 2 + 200);
						two.lineTo(posX + barWidth, canvas.height - (dataArray[i + 1] + 150) * 2 * 2 + 200);
						two.stroke();
					} else {
						two.fillStyle = 'red';
						two.beginPath();
						two.arc(posX, canvas.height - barHeight * 2 + 200, barWidth, 0, 2 * Math.PI);
						two.fill();
						two.fillStyle = 'black';
						two.beginPath();
						two.arc(posX, canvas.height - barHeight * 2 + 200, barWidth / 2, 0, 2 * Math.PI);
						two.fill();
					}
					posX += barWidth;
				}
			};

			draw();
		</script>
	</body>
</html>